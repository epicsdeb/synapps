<html>

<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta name="Originator" content="Microsoft Word 9">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<title>smartControl</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Mark Rivers</o:Author>
  <o:LastAuthor>Mark Rivers</o:LastAuthor>
  <o:Revision>5</o:Revision>
  <o:TotalTime>48</o:TotalTime>
  <o:Created>2000-08-10T00:47:00Z</o:Created>
  <o:LastSaved>2000-08-10T01:11:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Company>CARS</o:Company>
  <o:Lines>1</o:Lines>
  <o:Paragraphs>1</o:Paragraphs>
  <o:Version>9.2720</o:Version>
 </o:DocumentProperties>
</xml><![endif]-->
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>0</w:DisplayVerticalDrawingGridEvery>
  <w:UseMarginsForDrawingGridOrigin/>
  <w:Compatibility>
   <w:FootnoteLayoutLikeWW8/>
   <w:ShapeLayoutLikeWW8/>
   <w:AlignTablesRowByRow/>
   <w:ForgetLastTabAlignment/>
   <w:LayoutRawTableWidth/>
   <w:LayoutTableRowsApart/>
  </w:Compatibility>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman"; margin-left:0in; margin-right:0in; margin-top:0in}
h1
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:16.0pt;
	font-family:Arial;
	mso-font-kerning:16.0pt;}
h2
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:14.0pt;
	font-family:Arial;
	font-style:italic;}
h3
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:13.0pt;
	font-family:Arial;}
h4
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:4;
	font-size:14.0pt;
	font-family:"Times New Roman";}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
 /* List Definitions */
@list l0
	{mso-list-id:147745543;
	mso-list-type:hybrid;
	mso-list-template-ids:2028517282 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l1
	{mso-list-id:533470917;
	mso-list-type:hybrid;
	mso-list-template-ids:1569775248 67698689 67698691 67698693 67698689 67698691 67698693 67698689 67698691 67698693;}
@list l1:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	font-family:Symbol;}
@list l2
	{mso-list-id:577136603;
	mso-list-type:hybrid;
	mso-list-template-ids:214329800 67698703 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l3
	{mso-list-id:1320226720;
	mso-list-type:hybrid;
	mso-list-template-ids:214329800 67698689 67698713 67698715 67698703 67698713 67698715 67698703 67698713 67698715;}
@list l3:level1
	{mso-level-number-format:bullet;
	mso-level-text:\F0B7;
	mso-level-tab-stop:.5in;
	mso-level-number-position:left;
	text-indent:-.25in;
	font-family:Symbol;}
ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>
</head>

<body lang="EN-US" style="tab-interval:.5in">

<h1 align="center" style="text-align:center">smartControl: Using
the Bruker SMART Detector Software with EPICS</h1>

<h2 align="center" style="text-align:center"><a
href="mailto:rivers@cars.uchicago.edu">Mark Rivers</a></h2>

<h2 align="center" style="text-align:center">January 28, 2004</h2>

<h2>Contents</h2>

<ul>
    <li><a href="#Overview">Overview</a></li>
    <li><a href="#Implementation">Implementation</a></li>
    <li><a href="#Hardware setup">Hardware Setup</a></li>
    <li><a href="#vxWorks startup file">vxWorks Startup File</a></li>
    <li><a href="#Source Code and Installation">Source Code and
        Installation</a></li>
    <li><a href="#MEDM screens">MEDM Screens</a></li>
    <li><a href="#Motor Performance">Motor Performance</a></li>
    <li><a href="#Restrictions">Restrictions</a></li>
</ul>

<p>&nbsp;</p>

<h2><a name="Overview">Overview</a></h2>

<p>The Bruker SMART CCD detector system is used to collect single
crystal or powder diffraction data. Many APS users are familiar
with this system from their home laboratories, and it is
desireable to be able to use the same software to collect data at
the APS using any beamline diffractometer and shutter system.
However, the SMART software is written specifically to talk to
the Bruker General Goniometer Control System (GGCS) motor/shutter
controller. Most beamlines require EPICS control of their
diffractometer for use with other software (e.g. SPEC), and will
not want to install the GGCS hardware for use only with the SMART
software.</p>

<p>The GGCS communicates with the PC running SMART via an RS-232
serial interface. The solution which I have developed is to make
an EPICS IOC emulate the GGCS, so that the SMART software <em>thinks</em>
it is talking to a GGCS, while it is actually communicating with
EPICS.</p>

<p>There are two version of the SMART software: the standard
Eulerian geometry version, and the Kappa geometry version. This
EPICS software should work with either one, but it has only been
tested with Kappa SMART so far. The nomenclature of the SNL
program, the database and the medm screen assume the Kappa
geometry. If the Eulerian version of SMART is used then one
should substitute values for the chi motor wherever the kappa
motor is referenced.</p>

<p>SMART can control up to 4 diffractometer axes. These are
2-theta, omega, phi and kappa (or chi). This EPICS software will
also work with diffractometers with fewer axes, and we have
successfully used it to collect data with a simple system with a
single rotation stage, which could be called phi or omega.</p>

<h2><a name="Implementation">Implementation</a></h2>

<p>The EPICS implementation consists of the following:</p>

<ul>
    <li>A database file, <code>smartControl.db.</code> This
        database contains almost no &#147;logic&#148; with no
        links between records in the database. The records are
        simply variables which channel access clients and the
        State Notation Language (SNL) program use.</li>
    <li>An SNL program, <code>smartControl.st.</code> This
        program implements all of the logic for emulating the
        GGCS, controlling EPICS motors and PVs to control the
        shutter and detector trigger.</li>
    <li>An MEDM screen, <code>smartControl.adl</code>. This
        screen is used to configure and monitor the SNL program.</li>
</ul>

<h2><a name="Hardware setup">Hardware setup</a></h2>

<p>The SMART system and the EPICS IOC must be connected as
follows:</p>

<ul>
    <li>The serial port from the SMART PC which would normally
        connect to the GGCS (typically COM1) must be connected to
        a serial port on the EPICS IOC. This must be a port which
        works with the Generic Serial Record, typically an
        IP-Octal serial module running under MPF or Hideos.</li>
    <li>A TTL output signal from the EPICS IOC must be connected
        to the detector trigger input on the SMART CCD camera
        controller. This output must be controllable via EPICS,
        typically a binary output record. We use the IP-Unidig
        digital I/O module, but any supported binary output port
        will work.</li>
    <li>EPICS must be able to open and close a fast x-ray
        shutter. We use the Bruker shutter, controlled with a
        second IP-Unidig output, but any EPICS record which
        controls a suitable shutter will work.</li>
    <li>There must be between 1 and 4 EPICS motors controlling
        the diffractometer rotation axes. These must use the
        EPICS &quot;motor&quot; record. Any supported motor
        controller can be used, e.g. OMS-58, Newport MM4005, etc.</li>
</ul>

<h2><a name="vxWorks startup file">vxWorks startup file</a></h2>

<p>The following are the comments from the beginning of <code>smartControl.db</code>
which describe the macro parameters which must be supplied in the
<code>dbLoadRecords</code> command in the vxWorks startup script.</p>

<pre>#  This database works with SNL program smartControl.st to allow SMART to
#  control EPICS motors
#
#                   Mark Rivers
#                   September 17, 2000
#
# Macro parameters:
#   $(P)        - PV name prefix
#   $(R)        - PV base record name
#   $(C)        - Card # (0,1,2...) of the board with the IP slot for the
#                 generic serial records
#   $(IPSLOT)   - IP slot (A-D) for the serial I/O module
#   $(CHAN)     - Channel (0-7) for the serial port
#   $(BAUD)     - Baud rate for the serial port
#                 Note: The SMART PC is assumed to be configured with 8 data
#                 bits, 1 stop bit, no parity.
#   $(FSHUT)    - Name of PV to control fast shutter
#   $(SSHUT)    - Name of PV to control slow shutter
#   $(TRIG)     - Name of PV to control detector trigger
</pre>

<ul>
    <li><code>$(P)</code> is the prefix for this IOC, for example
        <code>13IDC:</code></li>
    <li><code>$(R)</code> is a record base name for this SMART
        detector, for example <code>smart1:</code> for the first
        SMART detector run through this IOC. </li>
    <li>The parameters relating to the serial port (<code>$(C),
        $(IPSLOT), $(CHAN), $(BAUD)</code>) define the
        communications between the SMART PC and the IOC. This
        database assumes that the Hideos or MPF server has a name
        like <code>a-Serial[0]</code>. If another naming
        convention is used then the database will need to be
        modified.</li>
    <li><code>$(FSHUT)</code> must be the name of an EPICS PV
        which closes the fast x-ray shutter when it has the value
        1, and opens the shutter when it has the value 0. </li>
    <li><code>$(SSHUT)</code> is a similar PV for a slow shutter,
        for example a shutter on an x-ray generator. Such
        hardware of often not used on a beamline, but the PV must
        exist. One should use a soft binary output record or an
        unused output of a digital I/O board if there is no slow
        shutter hardware. </li>
    <li><code>$(TRIG)</code> is the name of an EPICS PV which
        controls the TTL trigger input on the CCD controller. It
        has the value 0 to turn the detector on, and 1 to turn it
        off.</li>
</ul>

<p>The following is an example of the lines which must be put in
the vxWorks startup file to load <code>smartControl.db.</code>
Note that the command line is longer than the vxWorks limit, so
the command must be built using <code>malloc</code>, <code>strcpy</code>
and <code>strcat</code>.</p>

<pre># SMART detector database
str=malloc(256)
strcpy(str,&quot;P=13IDC:,R=smart1,C=0,IPSLOT=a,CHAN=6,BAUD=9600,&quot;)
strcat(str,&quot;FSHUT=UnidigBo0,TRIG=UnidigBo1,SSHUT=UnidigBo2&quot;)
dbLoadRecords(&quot;CARSApp/Db/smartControl.db&quot;,str)
</pre>

<p>After <code>iocInit</code> is called in the startup script the
SNL program must be started. Here is an example:</p>

<pre>seq &amp;smartControl, &quot;P=13IDC:,R=smart1,TTH=m29,OMEGA=m27,PHI=m25,KAPPA=m26,SCALER=scaler1,I0=2,stack=10000&quot;
</pre>

<p>In this command <code>P</code> and <code>R</code> are the same
as that used in loading the database. </p>

<p><code>TTH, OMEGA, PHI</code> and <code>KAPPA</code> are the
names of the EPICS motors controlling these axes. These motors
are assumed to be in the same IOC that is running the SNL
program, and to be named <code>$(P)mN</code>, for example <code>13IDC:m29</code>.
</p>

<p><code>SCALER</code> is the name of an EPICS scaler record
which should be used to obtain normalization information for each
frame. <code>I0</code> is the number of the scaler channel (1, 2,
...) which contains that normalization information. Ideally this
should be an ion chamber mounted downstream of the shutter, so
that it records the integrated beam intensity seen by the sample
during each frame. This information is passed to SMART and is
written in the data files for normalization by SAINT. The scaler
is assumed to be in the same IOC that is running the SNL program,
and to be named <code>$(P)$(SCALER)</code>, for example <code>13IDC:scaler1</code>.</p>

<p>If an Eulerian geometry is being used then set <code>KAPPA</code>
to the name of the EPICS motor controlling chi. If the
diffractometer contains fewer than 4 axes, then set the unused
axes to the same EPICS motor as one of the axes which is used.
The MEDM screen will be used to tell the SNL program not to move
axes which don't exist. For example, if the diffractometer
contains a single axis, phi, which is motor <code>m29</code> then
the command might look like.</p>

<pre>smartControl,P=13IDC:,R=smart1,TTH=m29,OMEGA=m29,PHI=m29,KAPPA=m29,SCALER=scaler1,I0=2,stack=10000&quot;
</pre>

<h2><a name="Source Code and Installation">Source Code and
Installation</a></h2>

<p>The source files for <code>smartControl</code> are available in the
<a href="ccd.html">ccd</a> application.&nbsp; <br>
</p>

<h2><a name="MEDM screens">MEDM screens</a></h2>

<p>The following shows the MEDM screen (<code>smartControl.adl</code>)
with which the user can view and modify the <code>smartControl</code>
database parameters. <code>smartControl.adl</code> is called with
macro parameters <code>P</code> and <code>R</code>. These are the
prefix and record base used when the database was loaded. </p>

<h2><img src="smartControl.jpg" width="578" height="602"></h2>

<p><code>Debugging level</code> is used to control debugging
print statements to the vxWorks console port. The values range
from 0 (no output), 1 (errors and warnings only) through 5
(maximum amount of debugging output). This output can be useful
for seeing what commands are being received from SMART, and the
responses being sent back to SMART. Note, however, that debugging
output reduces the performance of <code>smartControl</code> and
so <code>Debugging level </code>should normally be set to 0.</p>

<p><code>Detector trigger</code>, <code>Fast shutter</code> and <code>Slow
shutter</code> are used to monitor the state of these control
signals, and also to change them manually if desired.</p>

<p>Under the <code>Setup</code> menu are 5 controls for each
motor. </p>

<ul>
    <li><code>Exists</code> is a flag which is used to signal
        whether or not a given axis actually exists. If an axis
        does not exist then <code>smartControl</code> will not
        attempt to communicate with that EPICS motor.</li>
    <li><code>Offset</code> and <code>Sign</code> are used to
        convert from the EPICS motor coordinate system to the
        SMART coordinate system. The equation relating the two is
        <code>EPICS = Offset + Sign*SMART</code>. If the
        coordinate systems are the same then <code>Offset</code>
        should be 0 and <code>Sign</code> should be <code>Positive</code>
        (1). If the sign convention is different for EPICS and
        SMART then <code>Sign</code> should be <code>Negative</code>
        (-1).</li>
    <li><code>High cut</code> and <code>Low cut</code> are used
        to determine when the axis should &quot;roll-over&quot;
        by 360 degrees. The relationship, in EPICS motor
        coordinates, is:<ul>
            <li>If the target position is greater than <code>High
                cut</code> then the target position is
                decremented by 360 degrees. </li>
            <li>If the target position is less than <code>Low cut</code>
                then the target position is incremented by 360
                degrees.</li>
        </ul>
    </li>
</ul>

<p>Under the SMART Motor Values screen are 4 values for each
motor.</p>

<ul>
    <li><code>Position</code> is the last position which SMART
        commanded this motor to move to. If the motor has never
        been told to move by SMART then this value will be 0.</li>
    <li><code>Velocity</code> is the last velocity command which
        SMART issued for this motor. If the motor has never been
        sent a velocity command then this value will be 0.</li>
    <li><code>Low limit</code> and <code>High limit</code> are
        the last limit values which SMART issued for this motor.</li>
</ul>

<h2><a name="Motor Performance">Motor Performance</a></h2>

<p>The EPICS motor record specifies an acceleration time in
seconds rather than a true acceleration value, for example in
deg/sec/sec. Using a constant acceleration time is not ideal for
oscillation diffraction measurements, since it can lead to
excessively long acceleration times when the oscillation speed is
small. For example, on our Newport diffractometer the phi axis
has a maximum speed of 4 deg/sec, and a maximum acceleration
value of 16 deg/sec/sec. This means that we program the EPICS
motor <code>.VELO</code> field to 4 deg/sec and the <code>.ACCL</code>
field to 0.25 seconds. However, for an oscillation frame in SMART
we might use a 0.2 degree oscillation and 2 second exposure, for
a speed of 0.1 deg/sec. If the acceleration time is unchanged
then the motor will spend 0.5 seconds accelerating and
decelerating, which is 25% of the total exposure time.
Reflections which are in the Bragg condition during these times
will appear too intense. However, it is not necessary to have
such long acceleration times for a 0.1 deg/sec move. Since the
motor can accelerate at 16 deg/sec/sec, the acceleration time can
be reduced to 0.007 seconds.</p>

<p>To minimize the time spent accelerating and decelerating <code>smartControl</code>
does the following:</p>

<ul>
    <li>When the SNL program starts it assumes that the <code>.VELO</code>
        field for each motor is set to the maximum slew speed in
        deg/sec, and the <code>.ACCL</code> field is set to the
        minimum acceleration time for that slew speed. It
        computes the maximum acceleration in deg/sec/sec.
        Whenever a motor is moved by SMART the acceleration time
        is recomputed using the current velocity to maintain a
        constant true acceleration in deg/sec/sec. This leads to
        both faster data collection and more accurate
        intensities.</li>
</ul>

<p>With the Newport diffractometer and the MM4005 motor
controller there is a global variable <code>drvMM4000ReadbackDelay</code>
which controls the time between when the MM4005 reports that the
motor has stopped moving and when the driver reads the final
position of the motor. This delay is a temporary fix to allow for
the settling times of the DC motors. When using EPICS to
step-scan, for example with SPEC, this value must be set to the
worst-case settling time of any axis. We use a value of 0.5
seconds on our diffractometer. However, when using the
diffractometer with SMART and collecting oscillation data with
the phi axis <code>drvMM4000ReadbackDelay</code> should be set to
0.0. If it is left at 0.5 seconds then each frame will be
collected for an additional 0.5 seconds at the final motor
position, which will clearly lead to incorrect intensities if
there are reflections in the Bragg condition at this point. The
phi axis does not have an on-axis encoder and has a very fast
settling time, so the delay is not necessary.</p>

<h2><a name="Restrictions">Restrictions</a></h2>

<p><code>smartControl</code> does not attempt a complete
emulation of the GGCS. The reason for this is that the GGCS
syntax is very arcane and difficult to parse, and SMART actually
only uses a small subset of the GGCS command set. What has been
done is to emulate all of the GGCS commands that the current
release of SMART actually uses. This leads to a potential problem
when new versions of SMART are released, since they may use
additional GGCS commands. <code>smartControl</code> will need to
be modified to emulate additional GGCS commands if this occurs.</p>

<p><code>smartControl</code> is limited in the accuracy of the
exposure timing by latencies in EPICS channel access, in the
motor driver and communication, and in the shutter operation. For
each frame the SNL program does the following in response to a
single command line from SMART:</p>

<ol>
    <li>Enables the CCD detector, waits for an amount of time
        commanded by SMART</li>
    <li>Opens the slow shutter, waits for an amount of time
        commanded by SMART</li>
    <li>Starts the EPICS scaler</li>
    <li>Opens the fast shutter</li>
    <li>Sets the motor acceleration time and slew speed</li>
    <li>Starts the motor moving</li>
    <li>Waits for the motor to finish moving</li>
    <li>Closes the fast shutter</li>
    <li>Reads the EPICS scaler</li>
    <li>Disables the detector</li>
    <li>Closes the slow shutter</li>
</ol>

<p>This approach works well if the exposure times are long
compared to the shutter opening time and the latencies between
steps 4-8 above. On APS undulator beamlines exposure times of
less than 1 second are feasible, and the latencies could be a
significant fraction of the exposure time. In general the EPICS
software latencies are very small, because although the SNL
program uses Channel Access, all of the PVs are actually in the
same IOC as the SNL program. The performance of <code>smartControl</code>
is probably very similar to an actual GGCS system, although no
measurements have been made yet to establish the latencies. </p>

<p>In the future <code>smartControl</code> will be enhanced to
use the trajectory scanning and synchronization features of the
MM4005 and OMS-58 motor controllers to improve the accuracy of
the exposure timing. This software will ensure that motor is
actually at the correct speed and position at the instant the
shutter opens and closes. This will require controller-specific
software and hardware.</p>
</body>
</html>