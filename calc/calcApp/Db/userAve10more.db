record(bo, "$(P)userAve$(N10)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N9)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N8)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N7)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N6)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N5)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N4)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N3)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N2)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(bo, "$(P)userAve$(N1)_mode") {
  field(DTYP, "Soft Channel")
  field(ZNAM, "CONTINUOUS")
  field(ONAM, "ONE-SHOT")
}

record(mbbo, "$(P)userAve$(N10)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N9)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N8)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N7)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N6)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N5)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N4)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N3)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N2)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(mbbo, "$(P)userAve$(N1)_algorithm") {
  field(DTYP, "Soft Channel")
  field(ZRST, "AVERAGE")
  field(ONST, "FIT-LINE")
  field(TWST, "AUTO")
}

record(bo, "$(P)DisableUserAves") {
  field(DTYP, "Soft Channel")
  field(OMSL, "closed_loop")
  field(OUT, "$(P)userAveEnable.VAL  PP MS")
  field(DOL, "0")
}

record(sub, "$(P)userAve$(N1)") {
  field(DESC, "User Average 1")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N1)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N1)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N10)") {
  field(DESC, "User Average 10")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N10)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N10)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N2)") {
  field(DESC, "User Average 2")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N2)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N2)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N3)") {
  field(DESC, "User Average 3")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N3)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N3)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N4)") {
  field(DESC, "User Average 4")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N4)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N4)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N5)") {
  field(DESC, "User Average 5")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N5)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N5)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N6)") {
  field(DESC, "User Average 6")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N6)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N6)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N7)") {
  field(DESC, "User Average 7")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N7)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N7)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N8)") {
  field(DESC, "User Average 8")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N8)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N8)_algorithm.VAL  NPP NMS")
}

record(sub, "$(P)userAve$(N9)") {
  field(DESC, "User Average 9")
  field(DISV, "0")
  field(SDIS, "$(P)userAveEnable.VAL  CA NMS")
  field(INAM, "initSubAve")
  field(SNAM, "SubAve")
  field(INPD, "$(P)userAve$(N9)_mode.VAL  NPP NMS")
  field(INPF, "$(P)userAve$(N9)_algorithm.VAL  NPP NMS")
}


# We want to behave correctly when driven by a putCallback to either
# $(P)userAve$(N1)_busy or $(P)userAve$(N1)_acquire.  When user writes 1 to _busy,
# he's checking whether a previously commanded measurement has finished.  We
# want to say "done" immediately if sub record has a valid result (sub.G==1),
# otherwise, we'll say "done" when sub.G transitions to 1.  However, if user
# has issued a "clear" command to the sub record, and the sub record hasn't
# acted on it yet (sub.C==1; note that sub record may be periodically scanned,
# in which case it won't see the "clear" command until it processes), then we
# decline to clear the busy record, even though the sub record may appear to
# be done.
# When user processes _acquire, he wants us to issue a "clear" command and
# set the busy record.  When the measurement completes, we'll clear the busy
# record.
record(seq, "$(P)userAve$(N1)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N1).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N1)_busy PP")
}
record(busy, "$(P)userAve$(N1)_busy") {
	field(ONAM, "Done?")
}
# Calc fields:
# A: "done" indicator from sub record (==1 if done)
# B: value of busy record.  If zero, calc is disabled by SDIS, so we don't need
#    to use the value, it's only linked so we'll process when it changes to 1.
# C: "clear" command stored in sub record.  If 1, user has issued a clear
#    command that has not yet been acted on by the sub record.  In this case,
#    calc yields zero, and we do nothing.
# So, if busy==1, and there is no outstanding "clear" command, and sub record is
# done, we write a zero to the busy record.
record(calcout, "$(P)userAve$(N1)_doneCalc") {
	field(SDIS, "$(P)userAve$(N1)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N1).G CP")
	field(INPB, "$(P)userAve$(N1)_busy CP")
	field(INPC, "$(P)userAve$(N1).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N1)_busy.VAL CA")
}


record(seq, "$(P)userAve$(N2)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N2).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N2)_busy PP")
}
record(busy, "$(P)userAve$(N2)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N2)_doneCalc") {
	field(SDIS, "$(P)userAve$(N2)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N2).G CP")
	field(INPB, "$(P)userAve$(N2)_busy CP")
	field(INPC, "$(P)userAve$(N2).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N2)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N3)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N3).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N3)_busy PP")
}
record(busy, "$(P)userAve$(N3)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N3)_doneCalc") {
	field(SDIS, "$(P)userAve$(N3)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N3).G CP")
	field(INPB, "$(P)userAve$(N3)_busy CP")
	field(INPC, "$(P)userAve$(N3).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N3)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N4)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N4).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N4)_busy PP")
}
record(busy, "$(P)userAve$(N4)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N4)_doneCalc") {
	field(SDIS, "$(P)userAve$(N4)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N4).G CP")
	field(INPB, "$(P)userAve$(N4)_busy CP")
	field(INPC, "$(P)userAve$(N4).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N4)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N5)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N5).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N5)_busy PP")
}
record(busy, "$(P)userAve$(N5)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N5)_doneCalc") {
	field(SDIS, "$(P)userAve$(N5)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N5).G CP")
	field(INPB, "$(P)userAve$(N5)_busy CP")
	field(INPC, "$(P)userAve$(N5).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N5)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N6)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N6).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N6)_busy PP")
}
record(busy, "$(P)userAve$(N6)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N6)_doneCalc") {
	field(SDIS, "$(P)userAve$(N6)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N6).G CP")
	field(INPB, "$(P)userAve$(N6)_busy CP")
	field(INPC, "$(P)userAve$(N6).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N6)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N7)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N7).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N7)_busy PP")
}
record(busy, "$(P)userAve$(N7)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N7)_doneCalc") {
	field(SDIS, "$(P)userAve$(N7)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N7).G CP")
	field(INPB, "$(P)userAve$(N7)_busy CP")
	field(INPC, "$(P)userAve$(N7).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N7)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N8)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N8).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N8)_busy PP")
}
record(busy, "$(P)userAve$(N8)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N8)_doneCalc") {
	field(SDIS, "$(P)userAve$(N8)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N8).G CP")
	field(INPB, "$(P)userAve$(N8)_busy CP")
	field(INPC, "$(P)userAve$(N8).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N8)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N9)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N9).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N9)_busy PP")
}
record(busy, "$(P)userAve$(N9)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N9)_doneCalc") {
	field(SDIS, "$(P)userAve$(N9)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N9).G CP")
	field(INPB, "$(P)userAve$(N9)_busy CP")
	field(INPC, "$(P)userAve$(N9).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N9)_busy.VAL CA")
}

record(seq, "$(P)userAve$(N10)_acquire") {
	field(DO1, "1")
	field(LNK1, "$(P)userAve$(N10).C PP")
	field(DO2, "1")
	field(LNK2, "$(P)userAve$(N10)_busy PP")
}
record(busy, "$(P)userAve$(N10)_busy") {
	field(ONAM, "Done?")
}
record(calcout, "$(P)userAve$(N10)_doneCalc") {
	field(SDIS, "$(P)userAve$(N10)_busy NPP")
	field(DISV, "0")
	field(INPA, "$(P)userAve$(N10).G CP")
	field(INPB, "$(P)userAve$(N10)_busy CP")
	field(INPC, "$(P)userAve$(N10).C NPP")
	field(CALC, "c?0:a")
	field(OOPT, "When Non-zero")
	field(DOPT, "Use OCAL")
	field(OCAL, "!a")
	field(OUT, "$(P)userAve$(N10)_busy.VAL CA")
}
