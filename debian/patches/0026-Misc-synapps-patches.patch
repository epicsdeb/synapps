From: Michael Davidsaver <mdavidsaver@bnl.gov>
Date: Wed, 27 Jul 2011 14:49:55 -0400
Subject: [PATCH] Misc synapps patches

---
 stream/src/AsynDriverInterface.cc       |   19 +++++++++++++++++++
 stream/src/ChecksumConverter.cc         |    8 ++++----
 stream/src/MantissaExponentConverter.cc |    4 ++--
 stream/src/devwaveformStream.c          |    1 +
 stream/srcSynApps/Makefile              |    2 +-
 5 files changed, 27 insertions(+), 7 deletions(-)

diff --git a/stream/src/AsynDriverInterface.cc b/stream/src/AsynDriverInterface.cc
index 6d4a7db..fd60faf 100644
--- a/stream/src/AsynDriverInterface.cc
+++ b/stream/src/AsynDriverInterface.cc
@@ -663,6 +663,16 @@ writeHandler()
                 clientName(), pasynUser->errorMessage);
             writeCallback(StreamIoFault);
             return;
+        case asynDisconnected:
+            error("%s: asynDisconnected in write: %s\n",
+                clientName(), pasynUser->errorMessage);
+            writeCallback(StreamIoFault);
+            return;
+        case asynDisabled:
+            error("%s: asynDisabled in write: %s\n",
+                clientName(), pasynUser->errorMessage);
+            writeCallback(StreamIoFault);
+            return;
     }
 }
 
@@ -922,6 +932,15 @@ readHandler()
                     clientName(), pasynUser->errorMessage);
                 readCallback(StreamIoFault, buffer, received);
                 break;
+            case asynDisconnected:
+                error("%s: asynDisconnected in read: %s\n",
+                    clientName(), pasynUser->errorMessage);
+                readCallback(StreamIoFault, buffer, received);
+                return;
+            case asynDisabled:
+                error("%s: asynDisabled in read: %s\n",
+                    clientName(), pasynUser->errorMessage);
+                readCallback(StreamIoFault, buffer, received);
         }
         if (!readMore) break;
         if (readMore > 0)
diff --git a/stream/src/ChecksumConverter.cc b/stream/src/ChecksumConverter.cc
index 4f77b6f..3956600 100644
--- a/stream/src/ChecksumConverter.cc
+++ b/stream/src/ChecksumConverter.cc
@@ -555,9 +555,9 @@ printPseudo(const StreamFormat& format, StreamBuffer& output)
     debug("ChecksumConverter %s: output to check: \"%s\"\n",
         checksumMap[fnum].name, output.expand(start,length)());
 
-    sum = checksumMap[fnum].xorout ^ checksumMap[fnum].func(
+    sum = checksumMap[fnum].xorout ^ (checksumMap[fnum].func(
         reinterpret_cast<uchar*>(output(start)), length,
-        checksumMap[fnum].init) & mask[checksumMap[fnum].bytes];
+        checksumMap[fnum].init) & mask[checksumMap[fnum].bytes]);
 
     debug("ChecksumConverter %s: output checksum is 0x%lX\n",
         checksumMap[fnum].name, sum);
@@ -616,9 +616,9 @@ scanPseudo(const StreamFormat& format, StreamBuffer& input, long& cursor)
         return -1;
     }
 
-    sum = checksumMap[fnum].xorout ^ checksumMap[fnum].func(
+    sum = checksumMap[fnum].xorout ^ (checksumMap[fnum].func(
         reinterpret_cast<uchar*>(input(start)), length,
-        checksumMap[fnum].init) & mask[checksumMap[fnum].bytes];
+        checksumMap[fnum].init) & mask[checksumMap[fnum].bytes]);
 
     debug("ChecksumConverter %s: input checksum is 0x%0*lX\n",
         checksumMap[fnum].name, 2*checksumMap[fnum].bytes, sum);
diff --git a/stream/src/MantissaExponentConverter.cc b/stream/src/MantissaExponentConverter.cc
index 060efb6..56d5a91 100644
--- a/stream/src/MantissaExponentConverter.cc
+++ b/stream/src/MantissaExponentConverter.cc
@@ -60,7 +60,7 @@ scanDouble(const StreamFormat& fmt, const char* input, double& value)
     sscanf(input, "%d%d%n", &mantissa, &exponent, &length);
     if (fmt.flags & skip_flag) return length;
     if (length == -1) return -1;
-    value = (double)(mantissa) * pow(10.0, exponent);
+    value = (double)(mantissa) * pow(10., exponent);
     return length;
 }
 
@@ -75,7 +75,7 @@ printDouble(const StreamFormat& fmt, StreamBuffer& output, double value)
     int prec = fmt.prec;
     
     if (prec < 1) prec = 6;
-    buf.printf("%.*e", prec-1, fabs(value)/pow(10.0, prec-1));
+    buf.printf("%.*e", prec-1, fabs(value)/pow(10., prec-1));
     buf.remove(1,1);
     buf.remove(buf.find('e'),1);
     
diff --git a/stream/src/devwaveformStream.c b/stream/src/devwaveformStream.c
index 0f16476..591e6f9 100644
--- a/stream/src/devwaveformStream.c
+++ b/stream/src/devwaveformStream.c
@@ -19,6 +19,7 @@
 ***************************************************************/
 
 #include "devStream.h"
+#include <errlog.h>
 #include <waveformRecord.h>
 #include <string.h>
 #include <epicsExport.h>
diff --git a/stream/srcSynApps/Makefile b/stream/srcSynApps/Makefile
index ce4e96b..2b16146 100644
--- a/stream/srcSynApps/Makefile
+++ b/stream/srcSynApps/Makefile
@@ -14,7 +14,7 @@ SRCS += $(LIBRARY_DEFAULT)_registerRecordDeviceDriver.cpp
 endif 
 SRCS += $(SYNAPPS_RECORDS:%=dev%Stream.c)
 
-LIB_LIBS += stream dbIoc registryIoc iocsh
+LIB_LIBS += stream dbIoc registryIoc
 
 include $(TOP)/configure/RULES
 
-- 
